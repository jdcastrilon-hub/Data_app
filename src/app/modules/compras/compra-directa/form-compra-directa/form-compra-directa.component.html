<form [formGroup]="formulario" (ngSubmit)="enviarFormulario()">
    <mat-card appearance="raised">
        <mat-card-header class="mat-header">
            <mat-card-title>COMPRA DIRECTA</mat-card-title>
        </mat-card-header>
        <div style="height: 1px; background-color: rgb(201, 199, 199); margin: 1px 0;"></div>
        <mat-tab-group animationDuration="0ms" mat-stretch-tabs="false" mat-align-tabs="start">

            <mat-tab label="Datos Generales" style="background-color: brown;">

                <div class="bloque">

                    <div fxLayout="row" fxLayoutAlign="space-between stretch" fxLayoutGap="5px">

                        <div fxFlex="15">
                            <mat-form-field class="form-field-compacto mat-form-field" appearance="outline">
                                @if (!isEditMode){
                                <mat-label>Sucursal</mat-label>
                                }
                                <mat-select [formControl]="SelectSucursalControl" required>
                                    @for (obj_sucursal of list_sucursal; track obj_sucursal) {
                                    <mat-option [value]="obj_sucursal">{{obj_sucursal.nomSucursal}}</mat-option>
                                    }
                                </mat-select>
                                @if (SelectSucursalControl.hasError('required')) {
                                <mat-error>Debe seleccionar una sucursal</mat-error>
                                }
                            </mat-form-field>
                        </div>
                        <div fxFlex="40">
                            <combo-proveedor formControlName="searchProveedor"
                                (proveedorSelecionado)="onProveedorChange($event)"></combo-proveedor>
                        </div>
                        <div fxFlex="15">
                            <mat-form-field class="form-field-compacto form-field-date" appearance="outline">
                                <mat-label>Fecha Compra</mat-label>
                                <input matInput [matDatepicker]="picker" placeholder="dd/mm/yyyy"
                                    formControlName="fecDoc">
                                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                                <mat-datepicker #picker></mat-datepicker>
                            </mat-form-field>
                        </div>
                        <div fxFlex="15">
                            <mat-form-field class="form-field-compacto mat-form-field" appearance="outline">
                                <mat-label>Numero Compra</mat-label>
                                <input matInput formControlName="nroDocum">
                                <mat-error>Codigo requerido</mat-error>
                            </mat-form-field>
                        </div>
                        <div fxFlex="15">
                            <mat-form-field class="form-field-compacto mat-form-field" appearance="outline">
                                <mat-label>Status</mat-label>
                                <mat-select [formControl]="SelecStatusControl" required>
                                    @for (obj_tipo of list_status; track obj_tipo) {
                                    <mat-option [value]="obj_tipo">{{obj_tipo}}</mat-option>
                                    }
                                </mat-select>
                                @if (SelecStatusControl.hasError('required')) {
                                <mat-error>Debe seleccionar una opcion</mat-error>
                                }
                            </mat-form-field>
                        </div>
                    </div>

                </div>


                <div style="height: 1px; background-color: rgb(201, 199, 199); margin: 1px 0;"></div>

                <table mat-table [dataSource]="dataSource" class="mat-elevation-z8 tabla-compacta"
                    formArrayName="detalles">
                    <ng-container matColumnDef="id">
                        <mat-header-cell *matHeaderCellDef> Art√≠culo </mat-header-cell>
                        <mat-cell *matCellDef="let row; let i = index" [formGroupName]="i" class="celda-compacta">
                            <articulo-autocomplet formControlName="search"
                                (articuloSeleccionado)="onArticuloChange($event, i)"></articulo-autocomplet>
                            <button mat-icon-button color="primary" type="button" (click)="eliminarLineaDetalles(i)">
                                <mat-icon>remove</mat-icon>
                            </button>
                        </mat-cell>
                        <td mat-footer-cell *matFooterCellDef>totales</td>
                    </ng-container>
                    <ng-container matColumnDef="costo">
                        <th mat-header-cell *matHeaderCellDef>Costo</th>
                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                            <input matInput formControlName="costoUnit" placeholder="Nombre" />
                            <mat-error *ngIf="row.get('costoUnit')?.hasError('required')">
                                La cantidad es obligatoria.
                            </mat-error>
                            <mat-error *ngIf="row.get('costoUnit')?.hasError('min')">
                                La cantidad debe ser mayor a 0.
                            </mat-error>
                        </td>
                        <td mat-footer-cell *matFooterCellDef></td>
                    </ng-container>
                    <ng-container matColumnDef="cantidad">
                        <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                            <input matInput formControlName="cantidad" placeholder="Nombre" />
                            <mat-error *ngIf="row.get('cantidad')?.hasError('required')">
                                La cantidad es obligatoria.
                            </mat-error>
                            <mat-error *ngIf="row.get('cantidad')?.hasError('min')">
                                La cantidad debe ser mayor a 0.
                            </mat-error>
                        </td>
                        <td mat-footer-cell *matFooterCellDef>
                            {{ totalCantidad | number}}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="neto">
                        <th mat-header-cell *matHeaderCellDef>Neto</th>
                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                            <span>
                                {{ row.get('costoTotal')?.value }}
                            </span>
                            <input type="hidden" formControlName="costoTotal">
                        </td>
                        <td mat-footer-cell *matFooterCellDef>
                            {{ totalNeto | currency }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="impuesto1">
                        <th mat-header-cell *matHeaderCellDef>Imp. (IVA)</th>
                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">

                            <select formControlName="objimpuesto1" class="input-tabla-select"
                                [compareWith]="compareImpuestos">
                                @for (obj_impuesto of list_impuestos; track obj_impuesto) {
                                <!--[ngValue] para que Angular trate el valor como un objeto y no como un string.-->
                                <option [ngValue]="obj_impuesto">
                                    {{ obj_impuesto.descripcion }}
                                </option>
                                }
                            </select>
                        </td>
                        <td mat-footer-cell *matFooterCellDef></td>
                    </ng-container>

                    <ng-container matColumnDef="imp1">
                        <th mat-header-cell *matHeaderCellDef>Valor IVA</th>
                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                            <span>
                                {{ row.get('valorImpuesto1')?.value }}
                            </span>
                            <input type="hidden" formControlName="valorImpuesto1">
                        </td>
                        <td mat-footer-cell *matFooterCellDef>
                            {{ totalNeto | currency }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="total">
                        <th mat-header-cell *matHeaderCellDef>total</th>
                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                            <span>
                                {{ row.get('importeTotal')?.value }}
                            </span>
                            <input type="hidden" formControlName="importeTotal">
                        </td>
                        <td mat-footer-cell *matFooterCellDef>
                            {{ totalFinal | currency }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="Lote">
                        <th mat-header-cell *matHeaderCellDef>Lote</th>
                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                            <input matInput formControlName="idLote" placeholder="Nombre" />
                            <mat-error *ngIf="row.get('idLote')?.hasError('required')">
                                La cantidad es obligatoria.
                            </mat-error>
                            <mat-error *ngIf="row.get('idLote')?.hasError('min')">
                                La cantidad debe ser mayor a 0.
                            </mat-error>
                        </td>
                        <td mat-footer-cell *matFooterCellDef></td>
                    </ng-container>


                    <ng-container matColumnDef="stock">
                        <th mat-header-cell *matHeaderCellDef>Stock</th>
                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                            <span>
                                {{ row.get('stock')?.value }}
                            </span>
                            <input type="hidden" formControlName="stock">
                        </td>
                        <td mat-footer-cell *matFooterCellDef></td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    <tr mat-footer-row *matFooterRowDef="displayedColumns" sticky="true" class="footer-resaltado"></tr>
                </table>

            </mat-tab>

            <mat-tab label="Recepcion Mercancia" style="background-color: brown;">
                <div class="main-container">
                    <mat-card class="section facturacion">
                        <mat-card-header>
                            <mat-card-title>Remito</mat-card-title>
                        </mat-card-header>
                        <mat-card-content class="grid-form">

                            <mat-form-field class="form-field-compacto mat-form-field" appearance="outline">
                                <mat-label>Bodega</mat-label>
                                <mat-select [formControl]="SelectBodegasControl" required>

                                    @for (obj_bodega of list_bodegas; track obj_bodega) {
                                    <mat-option [value]="obj_bodega">{{obj_bodega.nomBodega}}</mat-option>
                                    }
                                </mat-select>
                                @if (SelectBodegasControl.hasError('required')) {
                                <mat-error>Debe seleccionar una bodega</mat-error>
                                }
                            </mat-form-field>
                            
                            <combo-estadostock [editMode]="isEditMode" [input_objeto]="objeto"
                                (estadoSeleccionado)="recibirEstado($event)"></combo-estadostock>

                            <mat-form-field class="form-field-compacto mat-form-field" appearance="outline">
                                <mat-label>Remito</mat-label>
                                <input matInput placeholder="Numero de Remito" formControlName="remito">
                            </mat-form-field>

                            <mat-form-field class="form-field-compacto mat-form-field" appearance="outline">
                                <mat-label>Ingresa Mercancia</mat-label>
                                <input matInput>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                                <mat-label>Observacion</mat-label>
                                <textarea matInput rows="3" formControlName="observaciones"></textarea>
                            </mat-form-field>
                        </mat-card-content>
                    </mat-card>

                    <div class="right-column">

                        <mat-card class="section totals-card">
                            <mat-card-header><mat-card-title>Totales</mat-card-title></mat-card-header>
                            <mat-card-content class="totals-grid">
                                <div class="total-row">
                                    <span>Neto</span>
                                    <input class="small-input" formControlName="impNeto" [readonly]="true"
                                        [value]="totalNeto | currency">
                                </div>
                                <div class="total-row"><span>Impuesto IVA</span>
                                    <input class="small-input" formControlName="valorImpuesto1" [readonly]="true"
                                        [value]="totalImpuesto1 | currency">
                                </div>
                                <div class="total-row"><span>Totales</span>
                                    <input class="small-input" formControlName="impTotal" [readonly]="true"
                                        [value]="totalFinal | currency">
                                </div>
                            </mat-card-content>
                        </mat-card>
                    </div>
                </div>
            </mat-tab>

        </mat-tab-group>
        <br>

        <mat-card-actions class="mat-accion-botones">
            <button mat-raised-button color="primary" type="submit">Guardar</button>
            <br>
            <button mat-raised-button color="warn" type="button">Salir</button>
        </mat-card-actions>

    </mat-card>

</form>